;/*FB_PKG_DELIM*/

__d("IEBAPI",["MAWBridge"],(function(a,b,c,d,e,f,g){"use strict";b=1;function a(a){return function(){for(var b=arguments.length,c=new Array(b),e=0;e<b;e++)c[e]=arguments[e];return d("MAWBridge").getBridge().sendAndReceive("backend","ebapi",{args:c,type:a})}}g.version=b;g.makeBridgedApi=a}),98);
__d("EBBridgedAPI",["IEBAPI"],(function(a,b,c,d,e,f,g){"use strict";a={isEbEnabled:d("IEBAPI").makeBridgedApi("isEbEnabled"),messageBulkPointQuery:d("IEBAPI").makeBridgedApi("messageBulkPointQuery"),messageRangeQueryForIndexing:d("IEBAPI").makeBridgedApi("messageRangeQueryForIndexing")};b=a;g["default"]=b}),98);
__d("LSIssueMessageQuery",["LSArrayGetObjectAt","LSBase64Encode.nop","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?d[0]=c.i64.cast([-1,4294967295]):(f=e.item,c.sequence([function(a){return d[9]=f.deviceId,d[8]=f.backupTenancy,d[7]=f.encryptionVersion,d[2]=void 0,c.i64.neq(d[2],void 0)?c.resolve(d[3]=d[2]):c.sequence([function(a){return d[10]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[11]=a[0],a})},function(a){return d[11]?d[20]=(d[10].push(c.i64.cast([0,0])),d[10]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[12]=a[0],a})},function(a){return d[12]?d[20]=(d[10].push(c.i64.cast([0,2])),d[10]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[13]=a[0],a})},function(a){return d[13]?d[20]=(d[10].push(c.i64.cast([0,3])),d[10]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[14]=a[0],a})},function(a){return d[14]?d[20]=(d[10].push(c.i64.cast([0,4])),d[10]):0,d[15]=c.createArray(),d[16]=c.i64.of_int32(d[10].length),c.i64.gt(d[16],c.i64.cast([0,0]))?c.loopAsync(d[16],function(a){return d[20]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[10],d[20]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(a){return d[23]=(d[15].push(d[21]),d[15])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[20]=c.createArray(),d[21]=c.i64.of_int32(d[15].length),c.i64.gt(d[21],c.i64.cast([0,0]))?c.loopAsync(d[21],function(a){return d[23]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[15],d[23]).then(function(a){return a=a,d[24]=a[0],d[25]=a[1],a})},function(a){return d[26]=(d[20].push(c.i64.to_string(d[24])),d[20])}])}):c.resolve()},function(a){return d[22]=d[20].join(","),d[17]=d[22]}])},function(a){return d[15].some(function(a){return c.i64.eq(d[7],a)})?d[18]=d[7]:d[18]=void 0,c.i64.neq(d[18],void 0)?d[19]=d[18]:d[19]=void 0,d[3]=d[19]}])},function(e){return c.i64.neq(d[3],void 0)?d[4]=d[3]:d[4]=c.i64.cast([0,0]),c.i64.neq(d[8],void 0)?d[5]=d[8]:d[5]=c.i64.cast([0,1]),c.i64.neq(d[9],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),f.ocmfClientStateBlob).then(function(a){return a=a,d[10]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),f.mailboxRootKeyBlob).then(function(a){return a=a,d[11]=a[0],a})},function(a){return d[12]=new c.Map(),d[12].set("ocmf_client_state_blob",d[10]==null?"":d[10]),d[12].set("mailbox_root_key",d[11]==null?"":d[11]),d[13]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[26]=(d[13].push(a.epochId),d[13])})},function(a){return d[24]="Queried locally available epochs. Count: ",d[14]=c.i64.of_int32(d[13].length),d[25]=c.i64.to_string(d[14]),d[15]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[15],d[24],d[15],d[25]].join("")),c.resolve()},function(e){return d[16]=new c.Map(),d[16].set("device_id",d[9]),d[16].set("raw_tokens",d[12]),d[16].set("locally_available_epochs",d[13]),d[17]=new c.Map(),d[17].set("act_thread_id",a[0]),d[17].set("request_id",a[1]),d[17].set("tam_thread_subtype",a[2]),d[17].set("source",a[4]),d[18]=new c.Map(),d[18].set("mps_message_query",a[3]),d[18].set("device_context",d[16]),d[18].set("sort_order_ms_list",a[5]),d[18].set("task_source",a[4]),d[19]=new c.Map(),d[19].set("restore_context",d[17]),d[19].set("success",d[18]),d[20]=d[19].get("restore_context"),d[21]=d[20].get("act_thread_id"),d[22]=c.toJSON(d[19]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[21]].join(""),c.i64.cast([0,50040]),d[22],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[6]=d[23]}]):c.resolve(d[6]=c.i64.cast([-1,4294967295]))},function(a){return d[0]=d[6]}]))})},function(a){return e[0]=d[0]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueMessageQueryStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSIssueMessageQueryStoredProcedure",["LSIssueMessageQuery","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueMessageQuery"),e.threadId,e.traceId,e.tamThreadSubtype,e.mpsMessageQuery,e.source,e.sortOrderMsList);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEncryptedBackupIssueBulkMessagesPointQuery",["EBBridgedAPI","FBLogger","I64","LSDatabaseSingleton","LSEncryptedBackupsBackupTenancy","LSFactory","LSIntEnum","LSIssueMessageQueryStoredProcedure","LSMEBTaskCreationSource","LSTamThreadSubtype","LSVec","MAWAsyncEBPendingQueryPromise","MAWEncryptedBackupUtils","MAWMainTraceUtils","MAWThreadIdToChatJidMapping","MWEncryptedBackUpEBNotEnabledError","Promise","asyncToGeneratorRuntime","err","gkx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("MWEncryptedBackupIssueBulkMessagesPointQuery"),m=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("MWEncryptedBackupIssueBulkMessagesPointQuery");function n(a,e,g,n,o,p,q,r,s,t){if(e!=null||a==null&&q==null){if(t!=null){d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(t,c("err")((e=e)!=null?e:"Error restoring from EB over graphQL in worker"))}}else c("promiseDone")((i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){if(q!=null){var e=d("MAWEncryptedBackupUtils").convertJSTypesToLSTypesForRestoreJob(q);yield m.load().then(function(h){return b.runInTransaction(function(b){return h(b,0,s,e,n,p!=null?p:void 0,g,o!=null?o:void 0,!0,t!=null?t:void 0,void 0,void 0,a!=null?c("LSVec").ofArray(a):void 0,r!=null?(j||(j=d("LSIntEnum"))).ofNumber(r):void 0)},"readwrite",void 0,void 0,f.id+":78")})}else if(a!=null){var h=c("LSVec").ofArray(a);yield l.load().then(function(a){return b.runInTransaction(function(b){return a(b,0,(k||(k=d("I64"))).zero,h,n,p!=null?p:void 0,g,o!=null?o:void 0,!0,s,t!=null?t:void 0,void 0,r!=null?(j||(j=d("LSIntEnum"))).ofNumber(r):void 0,void 0)},"readwrite",void 0,void 0,f.id+":106")})}});return function(a){return e.apply(this,arguments)}}()));return(h||(h=b("Promise"))).resolve()}function a(a,e,g,i){if(!c("gkx")("23914"))return null;var l=d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("MAWEncryptedBackupUtils").getBackupTenancy(a.tables).then(function(m){if(m==null||!(k||(k=d("I64"))).equal(m,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))){d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(l,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(h||(h=b("Promise"))).resolve()}var o={__typename:"MPSMessageQuery",ctx:{__typename:"MPSQueryContext",caller:"HISTORY_RESTORE"},query:{__typename:"MPSMessagePointQuery",include_deleted:!1,otids:g.map(function(a){return a.id}),thread_id:e}},p=c("LSVec").ofArray([]);try{p=c("LSVec").ofArray(g.map(function(a){return(k||(k=d("I64"))).of_string(""+a.sortOrderMs)}))}catch(a){c("FBLogger")("maw_bulk_point_query").mustfix("message sort order ms is not a number %s",a.message)}if(c("gkx")("8971")){var q=c("LSVec").toArray(p).map(function(a){return(k||(k=d("I64"))).to_float(a)});return a.runInTransaction(function(a){return d("MAWThreadIdToChatJidMapping").genChatJidFromThreadId(a,e,"MWEncryptedBackupIssueBulkMessagesPointQuery")},"readwrite",void 0,void 0,f.id+":197").then(function(a){if(a==null){var b="Cannot generate ChatJid from threadId: "+e;d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(l,c("err")(b));return}return c("EBBridgedAPI").messageBulkPointQuery({chatJid:a,messageIds:g.map(function(a){return a.id}),sortOrderMsList:q,threadId:e,traceId:l}).then(function(a){if(a.success){var b=a.value;return n(b.echoMessages,void 0,b.hasMoreAfter,b.hasMoreBefore,b.nextMessageTimestampMsAfter,b.nextMessageTimestampMsBefore,b.protobufMessages,c("LSMEBTaskCreationSource").BULK_QUERY_FOR_SEARCH_RESULT,e,l)}else{b=a.error;d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(l,c("err")((a=b)!=null?a:"Error restoring from EB over graphQL in worker"))}})})}return a.runInTransaction(function(a){return c("LSIssueMessageQueryStoredProcedure")(c("LSFactory")(a),{mpsMessageQuery:JSON.stringify(o),sortOrderMsList:p,source:(j||(j=d("LSIntEnum"))).ofNumber(i),tamThreadSubtype:j.ofNumber(c("LSTamThreadSubtype").STANDARD),threadId:e,traceId:l})},"readwrite",void 0,void 0,f.id+":245")}));return l}g.runQuery=a}),98);
__d("MAWAsyncEBIssueBulkMessagesPointQuery",["LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MWEncryptedBackupIssueBulkMessagesPointQuery"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c,e){a=d("MWEncryptedBackupIssueBulkMessagesPointQuery").runQuery(a,b,c,e);return a==null?null:d("MAWAsyncEBPendingQueryPromise").getPendingQueryPromiseFromTrace(a)}function a(a,b,d){return h(a,b,d,c("LSMEBTaskCreationSource").BULK_QUERY_FOR_SEARCH_RESULT)}g.issueQueryAsPromiseForSearchResult=a}),98);