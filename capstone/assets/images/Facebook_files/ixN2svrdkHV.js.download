;/*FB_PKG_DELIM*/

__d("LSHandleFTSIndexMessageResponse",["LSArrayGetObjectAt","LSDecryptMessages","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSRestoreEchoBlobs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleFTSIndexMessageResponse] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.i64.neq(a[4],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[9]=!1:(e=b.item,d[12]=e.deviceId,c.i64.neq(d[12],void 0)?d[11]=c.i64.neq(d[12],a[4]):d[11]=!1,d[9]=d[11])})},function(a){return d[2]=d[9]}]):c.resolve(d[2]=!1)},function(e){return d[2]?c.resolve(0):c.sequence([function(b){return d[9]=a[3].get("request_id"),d[10]=a[3].get("reference_timestamp"),d[11]=a[3].get("restore_task_source"),d[12]=a[3].get("restore_operation_type"),c.i64.neq(a[4],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[19]=!1:(e=b.item,d[22]=e.deviceId,c.i64.neq(d[22],void 0)?d[21]=c.i64.neq(d[22],a[4]):d[21]=!1,d[19]=d[21])})},function(a){return d[13]=d[19]}]):c.resolve(d[13]=!1)},function(e){return d[13]?c.resolve((d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,110])),d[19].set("stored_procedure","LSEncryptedBackupsHandleFTSIndexMessageResponseStoredProcedure"),d[19].set("error_message",""),d[14]=d[19])):c.sequence([function(e){return c.storedProcedure(b("LSDecryptMessages"),a[0],a[2]).then(function(a){return a=a,d[19]=a[0],d[20]=a[1],a})},function(e){return d[19]!==void 0?c.sequence([function(a){return d[22]=c.createArray(),d[23]=c.i64.of_int32(d[19].length),c.i64.gt(d[23],c.i64.cast([0,0]))?c.loopAsync(d[23],function(a){return d[32]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[19],d[32]).then(function(a){return a=a,d[33]=a[0],d[34]=a[1],a})},function(a){return d[35]=d[33].get("value"),d[36]=(d[22].push(d[35]),d[22])}])}):c.resolve()},function(e){return d[24]=a[1].get("has_more_before"),d[25]=a[1].get("next_message_timestamp_ms_before"),d[26]=a[1].get("has_more_after"),d[27]=a[1].get("next_message_timestamp_ms_after"),c.nativeOperation(b("LSRestoreEchoBlobs.nop"),c.i64.cast([0,0]),d[22],d[24],d[25],d[26],d[27],!1,a[2],d[9],d[10],d[11],void 0).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],d[30]=a[2],a})},function(a){return d[28]?d[31]=void 0:(d[32]=new c.Map(),d[32].set("error_code",c.i64.cast([0,105])),d[32].set("stored_procedure","LSEncryptedBackupsHandleFTSIndexMessageResponseStoredProcedure"),d[32].set("error_message",""),d[31]=d[32]),d[21]=d[31]}]):c.resolve(d[21]=d[20])},function(a){return d[14]=d[21]}])},function(e){return d[14]!==void 0?c.sequence([function(e){return d[19]=d[14].get("error_code"),d[20]=d[14].get("stored_procedure"),d[21]=new c.Map(),d[21].set("error_code",d[19]),d[21].set("error_message",void 0==null?"":void 0),d[21].set("stored_procedure",d[20]),d[22]=new c.Map(),d[22].set("act_thread_id",a[2]),d[22].set("source",d[11]),d[22].set("restore_operation_type",d[12]),d[22].set("request_id",void 0),d[22].set("device_id",void 0),d[23]=new c.Map(),d[23].set("restore_context",d[22]),d[23].set("failure",d[21]),d[24]=d[23].get("queue_name"),d[24]!==void 0?d[25]=d[24]:(d[31]=d[23].get("restore_context"),d[32]=d[31].get("act_thread_id"),d[25]=["encrypted_backups_restore",":",d[32]].join("")),d[26]=c.toJSON(d[23]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),d[25],c.i64.cast([0,50030]),d[26],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[28]=d[14].get("error_code"),d[29]=d[14].get("error_code"),d[30]=" ",d[15]=["Failed (",d[30],c.i64.to_string(d[29]),d[30],")"].join("")}]):c.resolve(d[15]="Succeeded")},function(e){return d[16]="",d[17]=["Message Restore Status: ",d[16],d[15],d[16],". ACT Thread ID: ",d[16],a[2]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleFTSIndexMessageResponse] ","",d[17]].join("")),d[18]=c.createArray(),void 0!==void 0?d[19]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleFTSIndexMessageResponse",[d[17]].join(""),d[18],c.i64.cast([0,4]))}])},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleFTSIndexMessageResponse] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleFTSIndexMessageResponse",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleFTSIndexMessageResponseStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);